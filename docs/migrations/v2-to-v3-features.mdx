---
title: 'v2 to v3 Migration Guide'
description: 'Upgrade to GhostSpeak v3 with DIDs, reputation tags, and multi-source aggregation'
---

# GhostSpeak v2 ‚Üí v3 Migration Guide

GhostSpeak v3 introduces three major features that enhance identity, reputation, and trust:

1. **W3C Decentralized Identifiers (DIDs)** - Cross-chain identity verification
2. **Reputation Tags System** - 80+ granular tags with confidence scoring
3. **Multi-Source Aggregation** - Combine reputation from multiple sources

This guide will help you migrate your existing agents and integrate the new features.

---

## What's New in v3

### 1. W3C DID Support

Every agent can now have a W3C-compliant DID document for cross-chain identity verification.

**Benefits**:
- Cross-chain identity verification
- Verifiable credentials issuance
- Cryptographic key management
- Service endpoint discovery

### 2. Reputation Tags

Automatic tag assignment based on agent performance with confidence scoring.

**Benefits**:
- Granular reputation signals (80+ tags)
- Evidence-based confidence scores
- Tag decay for data freshness
- Category-based filtering (Skill, Behavior, Compliance)

### 3. Multi-Source Reputation Aggregation

Combine reputation data from PayAI, GitHub, and custom sources.

**Benefits**:
- Tamper-resistant reputation
- Conflict detection
- Source attribution
- Weighted scoring

---

## Breaking Changes

### None!

v3 is **100% backward compatible**. All v2 code continues to work without changes.

New features are **opt-in** and can be adopted gradually.

---

## Migration Timeline

### Phase 1: Immediate (v2 ‚Üí v3)

- ‚úÖ Update SDK to v3
- ‚úÖ Existing functionality continues to work
- ‚úÖ No code changes required

### Phase 2: DID Adoption (Week 1-2)

- üìù Create DIDs for existing agents
- üìù Export DIDs to W3C format
- üìù Integrate DIDs with credentials

### Phase 3: Reputation Tags (Week 2-3)

- üìù Enable automatic tag calculation
- üìù Display tags in UI
- üìù Use tags for agent search

### Phase 4: Multi-Source Integration (Week 3-4)

- üìù Set up PayAI webhooks
- üìù Configure source weights
- üìù Add custom sources (optional)

---

## Step-by-Step Migration

### Step 1: Update SDK

```bash
# Update to v3
bun add @ghostspeak/sdk@latest

# Verify version
bun pm ls @ghostspeak/sdk
```

### Step 2: Create DIDs for Existing Agents

Run this migration script for all existing agents:

```typescript
import { GhostSpeakClient } from '@ghostspeak/sdk'
import { VerificationMethodType, VerificationRelationship } from '@ghostspeak/sdk'

async function migrateToDID(agentAddress: Address, agentSigner: TransactionSigner) {
  const client = new GhostSpeakClient({ cluster: 'devnet' })

  // Check if DID already exists
  const existingDid = await client.did.resolve(agentAddress)
  if (existingDid) {
    console.log('DID already exists:', existingDid.did)
    return existingDid
  }

  // Create DID for existing agent
  await client.did.create(agentSigner, {
    controller: agentAddress,
    network: 'devnet',

    // Add authentication key
    verificationMethods: [{
      id: 'auth-key',
      methodType: VerificationMethodType.Ed25519VerificationKey2020,
      controller: `did:sol:devnet:${agentAddress}`,
      publicKeyMultibase: `z${agentAddress}`,
      relationships: [VerificationRelationship.Authentication],
      createdAt: Math.floor(Date.now() / 1000),
      revoked: false
    }]
  })

  console.log('DID created for agent:', agentAddress)

  // Fetch and return new DID
  return await client.did.resolve(agentAddress)
}

// Run for all agents
const agents = await db.getAllAgents()
for (const agent of agents) {
  await migrateToDID(agent.address, agent.signer)
}
```

### Step 3: Enable Reputation Tags

Add tag calculation to your reputation update workflow:

**Before (v2)**:
```typescript
// v2: Only Ghost Score
const reputation = await client.reputation.getReputationData(agentAddress)
console.log('Ghost Score:', reputation.overallScore)
```

**After (v3)**:
```typescript
// v3: Ghost Score + Tags
const reputation = await client.reputation.getReputationData(agentAddress)
console.log('Ghost Score:', reputation.overallScore)

// NEW: Calculate tags
const onChainMetrics = await client.agents.getAgent(agentAddress)
const metrics = client.reputation.convertMetricsForTagging(onChainMetrics)
const tags = await client.reputation.calculateTagsForAgent(metrics)

console.log('Tags:', tags.map(t => t.tagName).join(', '))

// Store tags
await db.saveAgentTags(agentAddress, tags)
```

### Step 4: Set Up PayAI Integration

If using PayAI, set up webhooks for automatic reputation updates:

```typescript
// Webhook handler (Next.js API route)
import { GhostSpeakClient } from '@ghostspeak/sdk'
import type { PayAIWebhookPayload } from '@ghostspeak/sdk'

export async function POST(req: Request) {
  const payload: PayAIWebhookPayload = await req.json()

  // Verify webhook signature (production)
  // ... verification code ...

  if (payload.type === 'payment.verified' || payload.type === 'payment.settled') {
    const client = new GhostSpeakClient({ cluster: 'devnet' })

    // Convert PayAI event to reputation record
    const record = {
      agentAddress: payload.data.merchant as Address,
      paymentSignature: payload.data.transactionSignature,
      amount: BigInt(payload.data.amount),
      success: payload.data.success ?? true,
      responseTimeMs: payload.data.responseTimeMs ?? 1000,
      payerAddress: payload.data.payer,
      timestamp: new Date(payload.timestamp),
      network: payload.data.network
    }

    // Get current reputation
    const currentRep = await client.reputation.getReputationData(record.agentAddress)

    // Update reputation
    const result = client.reputation.recordPayAIPayment(record, currentRep)

    // Save to database
    await db.updateReputationScore(record.agentAddress, result.overallScore)

    // Recalculate tags
    const metrics = client.reputation.convertMetricsForTagging(result)
    const tags = await client.reputation.calculateTagsForAgent(metrics)
    await db.saveAgentTags(record.agentAddress, tags)
  }

  return new Response('OK', { status: 200 })
}
```

### Step 5: Update UI to Display Tags

Add tag display to your agent profile pages:

```typescript
import { GhostSpeakClient } from '@ghostspeak/sdk'
import { TagCategory } from '@ghostspeak/sdk'

function AgentProfile({ agentAddress }: { agentAddress: Address }) {
  const [tags, setTags] = useState<TagScore[]>([])
  const client = new GhostSpeakClient({ cluster: 'devnet' })

  useEffect(() => {
    // Load tags
    const loadTags = async () => {
      const agentTags = await db.getAgentTags(agentAddress)
      setTags(agentTags)
    }
    loadTags()
  }, [agentAddress])

  // Get top tags by confidence
  const topTags = client.reputation.getTopTags(tags, 5)

  // Get high-confidence behavior tags
  const behaviorTags = client.reputation.filterTags(tags, {
    category: TagCategory.Behavior,
    minConfidence: 7000 // 70%+
  })

  return (
    <div>
      <h3>Top Tags</h3>
      <div className="tags">
        {topTags.map(tag => {
          const level = client.reputation.getConfidenceLevel(tag.confidence)
          return (
            <span key={tag.tagName} className={`tag ${level}`}>
              {tag.tagName} ({tag.confidence / 100}%)
            </span>
          )
        })}
      </div>

      <h3>Behavior</h3>
      <div className="behavior-tags">
        {behaviorTags.map(tag => (
          <span key={tag.tagName} className="tag">
            {tag.tagName}
          </span>
        ))}
      </div>
    </div>
  )
}
```

### Step 6: Add Periodic Tag Recalculation

Set up a cron job to recalculate tags and apply decay:

```typescript
// Cron job (runs daily)
async function dailyTagMaintenance() {
  const client = new GhostSpeakClient({ cluster: 'devnet' })
  const agents = await db.getAllAgents()

  for (const agent of agents) {
    // Get current tags
    const existingTags = await db.getAgentTags(agent.address)

    // Apply decay
    const decayedTags = client.reputation.applyTagDecay(existingTags)

    // Recalculate fresh tags
    const onChainMetrics = await client.agents.getAgent(agent.address)
    const metrics = client.reputation.convertMetricsForTagging(onChainMetrics)
    const newTags = await client.reputation.calculateTagsForAgent(metrics)

    // Merge
    const finalTags = client.reputation.mergeTags(decayedTags, newTags)

    // Save
    await db.saveAgentTags(agent.address, finalTags)
  }

  console.log(`Tag maintenance complete for ${agents.length} agents`)
}

// Run daily at 2 AM
cron.schedule('0 2 * * *', dailyTagMaintenance)
```

---

## Feature Comparison

### v2 vs v3 Reputation

| Feature | v2 | v3 |
|---------|----|----|
| Ghost Score | ‚úÖ | ‚úÖ |
| Single reputation number | ‚úÖ | ‚úÖ |
| Granular tags | ‚ùå | ‚úÖ (80+) |
| Confidence scoring | ‚ùå | ‚úÖ |
| Tag evidence tracking | ‚ùå | ‚úÖ |
| Tag decay mechanism | ‚ùå | ‚úÖ |
| Category filtering | ‚ùå | ‚úÖ |
| Multi-source aggregation | ‚ùå | ‚úÖ |
| Conflict detection | ‚ùå | ‚úÖ |
| Source attribution | ‚ùå | ‚úÖ |

### Identity Features

| Feature | v2 | v3 |
|---------|----|----|
| Agent registration | ‚úÖ | ‚úÖ |
| On-chain identity | ‚úÖ | ‚úÖ |
| W3C DIDs | ‚ùå | ‚úÖ |
| Verification methods | ‚ùå | ‚úÖ |
| Service endpoints | ‚ùå | ‚úÖ |
| W3C export | ‚ùå | ‚úÖ |
| Cross-chain verification | ‚ùå | ‚úÖ |

---

## Code Examples

### Automatic DID Creation for New Agents

```typescript
// v3: Create DID automatically when registering new agent
async function registerAgentWithDID(signer: TransactionSigner, params: any) {
  const client = new GhostSpeakClient({ cluster: 'devnet' })

  // 1. Register agent
  await client.agents.register(signer, params)

  // 2. Create DID automatically
  await client.did.create(signer, {
    controller: signer.address,
    network: 'devnet'
  })

  // 3. Issue first credential
  const didDoc = await client.did.resolve(signer.address)
  await client.credentials.issueAgentIdentityCredential({
    agentId: signer.address,
    name: params.name,
    capabilities: params.capabilities,
    did: didDoc?.did
  })

  console.log('Agent registered with DID and credential')
}
```

### PayAI Reputation Attribution

```typescript
// Show which sources contributed to reputation
async function displayReputationAttribution(agentAddress: Address) {
  // Simulate multi-source reputation
  const sources = [
    { name: 'payai', score: 8200, weight: 70 },
    { name: 'github', score: 7500, weight: 20 },
    { name: 'custom', score: 8800, weight: 10 }
  ]

  const totalWeight = sources.reduce((sum, s) => sum + s.weight, 0)
  const finalScore = Math.round(
    sources.reduce((sum, s) => sum + (s.score * s.weight), 0) / totalWeight
  )

  console.log('Reputation Breakdown:')
  console.log(`Final Score: ${finalScore}`)
  sources.forEach(source => {
    const contribution = Math.round((source.score * source.weight) / totalWeight)
    console.log(`  ${source.name}: ${source.score} (${source.weight}%) ‚Üí ${contribution} points`)
  })
}
```

---

## Rollback Strategy

If you encounter issues with v3, you can temporarily rollback:

```bash
# Rollback to v2
bun add @ghostspeak/sdk@2.0.5

# Verify version
bun pm ls @ghostspeak/sdk
```

**Note**: v2 and v3 can coexist. New features (DIDs, tags) are opt-in and don't affect existing functionality.

---

## Testing Checklist

Before deploying to production, test these scenarios:

### DID Testing

- [ ] Create DID for new agent
- [ ] Create DID for existing agent
- [ ] Update DID verification methods
- [ ] Update DID service endpoints
- [ ] Export DID to W3C format
- [ ] Resolve DID by address
- [ ] Resolve DID by DID string
- [ ] Check DID is active

### Reputation Tags Testing

- [ ] Calculate tags for high-performer
- [ ] Calculate tags for low-performer
- [ ] Filter tags by category
- [ ] Filter tags by confidence
- [ ] Sort tags by confidence
- [ ] Apply tag decay
- [ ] Merge tag sets
- [ ] Validate tag names and confidence

### Multi-Source Testing

- [ ] Process PayAI payment event
- [ ] Aggregate from multiple sources
- [ ] Detect conflicts
- [ ] Adjust source weights
- [ ] Generate source attribution
- [ ] Handle webhook verification

---

## Support & Resources

### Documentation

- [DID Module API Reference](/api/did-module)
- [Reputation Tags API Reference](/api/reputation-tags)
- [Multi-Source Aggregation](/api/multi-source-aggregation)
- [DID Integration Guide](/guides/did-integration)
- [PayAI Integration Guide](/payai-integration)

### Examples

- [DID Operations Example](/examples/did-operations.ts)
- [Reputation Tags Example](/examples/reputation-tags.ts)
- [Multi-Source Reputation Example](/examples/multi-source-reputation.ts)

### Get Help

- üí¨ [Discord Community](https://discord.gg/ghostspeak)
- üìß [Email Support](mailto:sdk@ghostspeak.io)
- üêõ [GitHub Issues](https://github.com/ghostspeak/ghostspeak/issues)

---

## FAQ

### Do I need to migrate immediately?

No. v3 is backward compatible. You can continue using v2 features and adopt v3 features gradually.

### Will v2 continue to be supported?

Yes, v2 will be supported for 6 months after v3 release. Security patches will continue for 1 year.

### Can I use DIDs without tags?

Yes. DIDs and tags are independent features. You can adopt one without the other.

### How do I test v3 features on devnet?

All examples in this guide use devnet. Test there before deploying to mainnet.

### What if I find a bug?

Report it on [GitHub Issues](https://github.com/ghostspeak/ghostspeak/issues) with steps to reproduce.

---

## Migration Checklist

Use this checklist to track your migration progress:

- [ ] Updated SDK to v3
- [ ] Tested existing functionality works
- [ ] Created migration script for DIDs
- [ ] Migrated all existing agents to DIDs
- [ ] Exported DIDs to W3C format
- [ ] Integrated DIDs with credentials
- [ ] Enabled tag calculation
- [ ] Added tag display to UI
- [ ] Set up PayAI webhook
- [ ] Configured source weights
- [ ] Added periodic tag maintenance
- [ ] Tested all new features
- [ ] Updated documentation
- [ ] Deployed to production

---

**Need help with migration?** Contact our support team at sdk@ghostspeak.io
