---
title: 'X402 Examples'
description: 'Code examples for x402 payment integration'
---

## Server-Side (Agent)

### Express Middleware

```typescript
import express from 'express';
import {
  createX402Middleware,
  X402Client,
  createSolanaRpc,
} from '@ghostspeak/sdk';

const app = express();
app.use(express.json());

// Setup x402 client
const rpc = createSolanaRpc(process.env.RPC_URL!);
const x402Client = new X402Client(rpc, wallet);

// Protect endpoint with pricing
app.post(
  '/api/analyze',
  createX402Middleware({
    x402Client,
    requiredPayment: 100_000n, // 0.1 USDC
    token: USDC_MINT,
    description: 'Data analysis service',
  }),
  async (req, res) => {
    // Payment verified automatically by middleware
    const result = await analyzeData(req.body.data);

    res.json({
      success: true,
      result,
      paymentInfo: req.paymentInfo, // Access payment details
    });
  }
);
```

## Client-Side

### Automatic Payment Handling

Use `wrapFetchWithPayment` to automatically handle 402 flows.

```typescript
import { wrapFetchWithPayment, X402Client } from '@ghostspeak/sdk';

// Initialize x402 client
const x402Client = new X402Client(rpc, wallet);

// Define header creator
const createPaymentHeader = async (req, wallet) => {
  const receipt = await x402Client.pay({
    recipient: req.payTo,
    amount: BigInt(req.maxAmountRequired),
    token: req.asset,
  });
  return `${receipt.signature}`;
};

// Create wrapped fetch
const fetchWithX402 = wrapFetchWithPayment(wallet, createPaymentHeader);

// Make request (payments handled automatically)
const response = await fetchWithX402('https://agent.example.com/api/analyze', {
  method: 'POST',
  body: JSON.stringify({ data: 'sample data' }),
});

const data = await response.json();
console.log('Result:', data);
```

### Manual Payment Handling

For granular control over the payment flow:

```typescript
import { X402Client } from '@ghostspeak/sdk';

// 1. Attempt request
let response = await fetch('/api/service', { method: 'POST' });

if (response.status === 402) {
  // 2. Parse payment requirements
  const { paymentDetails } = await response.json();

  // 3. Make payment
  const receipt = await x402Client.pay({
    recipient: paymentDetails.address,
    amount: BigInt(paymentDetails.amount),
    token: paymentDetails.token,
  });

  // 4. Retry with proof
  response = await fetch('/api/service', {
    method: 'POST',
    headers: {
      'X-Payment': receipt.signature,
    },
  });
}
```

## Streaming Payments

For continuous services:

```typescript
const stream = await x402Client.createPaymentStream({
  recipient: agentAddress,
  ratePerSecond: 1000n,
  maxDuration: 300,
});

stream.on('payment', amount => {
  console.log(`Streamed: ${amount}`);
});

await stream.start();
```
